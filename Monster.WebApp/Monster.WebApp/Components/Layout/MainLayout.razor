@inherits LayoutComponentBase
@using Monster.WebApp.Shared
@inject IHttpContextAccessor HttpContextAccessor
@inject IJSRuntime JSRuntime

<MudThemeProvider @ref="_mudThemeProvider" Theme="_theme" @bind-IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Style="background-color: var(--mud-palette-appbar-background); color: var(--mud-palette-appbar-text);">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h6" Class="ml-3" Style="font-weight: 700;">Southmw</MudText>
        <MudSpacer />
        
        @if (IsUserAuthenticated())
        {
            <MudText Typo="Typo.body2" Class="mr-3" Style="color: var(--mud-palette-appbar-text);">
                @GetDisplayName() 님
            </MudText>
        }
        
        <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                       Color="Color.Inherit"
                       OnClick="@ToggleDarkMode"
                       Class="mr-2" />
        
        <AuthorizeView>
            <Authorized>
                <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" LockScroll="true">
                    <ActivatorContent>
                        <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="cursor-pointer">
                            @context.User.Identity?.Name?.FirstOrDefault()
                        </MudAvatar>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem Href="/profile">
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                <MudText>내 프로필</MudText>
                            </div>
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Href="/api/auth/logout">
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Filled.Logout" Size="Size.Small" Color="Color.Error" />
                                <MudText Color="Color.Error">로그아웃</MudText>
                            </div>
                        </MudMenuItem>
                    </ChildContent>
                </MudMenu>
            </Authorized>
            <NotAuthorized>
                <MudButton Href="/account/login" Variant="Variant.Text" Color="Color.Inherit" Class="mr-2">로그인</MudButton>
                <MudButton Href="/account/register" Variant="Variant.Filled" Color="Color.Primary" DropShadow="false">회원가입</MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>
    
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="0">
        <NavMenu />
    </MudDrawer>
    
    <MudMainContent Class="pt-16 px-4">
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>


@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode = false;
    private MudThemeProvider _mudThemeProvider = null!;
    private MudTheme _theme = CustomTheme.Theme;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // localStorage에서 저장된 테마 설정 가져오기 (기본값: 라이트 모드)
            try
            {
                var savedTheme = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "theme");
                _isDarkMode = savedTheme == "dark";
            }
            catch
            {
                // SSR 또는 JS 사용 불가 시 기본값 라이트 모드
                _isDarkMode = false;
            }
            StateHasChanged();
        }
    }

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;

        // localStorage에 테마 설정 저장
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "theme", _isDarkMode ? "dark" : "light");
        }
        catch
        {
            // SSR 또는 JS 사용 불가 시 무시
        }
    }

    private bool IsUserAuthenticated()
    {
        return HttpContextAccessor.HttpContext?.User?.Identity?.IsAuthenticated == true;
    }

    private string GetDisplayName()
    {
        var displayNameClaim = HttpContextAccessor.HttpContext?.User?.FindFirst("DisplayName");
        return displayNameClaim?.Value ?? "사용자";
    }
}
