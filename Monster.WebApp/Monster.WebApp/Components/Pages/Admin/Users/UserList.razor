@page "/admin/users"
@using Monster.WebApp.Services.Auth
@using Monster.WebApp.Models.Auth
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "AdminOnly")]
@inject UserService UserService
@inject RoleService RoleService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>사용자 관리</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-6" Style="font-weight: 600;">사용자 관리</MudText>

    @if (_isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudCard Elevation="2">
            <MudCardContent>
                <!-- Search and Filter -->
                <MudGrid Spacing="2" Class="mb-4">
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_searchQuery"
                                     Label="검색"
                                     Variant="Variant.Outlined"
                                     Adornment="Adornment.End"
                                     AdornmentIcon="@Icons.Material.Filled.Search"
                                     OnAdornmentClick="SearchUsersAsync"
                                     OnKeyUp="@(async (e) => { if (e.Key == "Enter") await SearchUsersAsync(); })"
                                     Placeholder="사용자명, 이메일, 표시명" />
                    </MudItem>
                    <MudItem xs="12" sm="6" Style="display: flex; align-items: center; justify-content: flex-end;">
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  StartIcon="@Icons.Material.Filled.Refresh"
                                  OnClick="LoadUsersAsync">
                            새로고침
                        </MudButton>
                    </MudItem>
                </MudGrid>

                <!-- Users Table -->
                <MudTable Items="@_users" Hover="true" Dense="true" Class="mt-4">
                    <HeaderContent>
                        <MudTh>ID</MudTh>
                        <MudTh>사용자명</MudTh>
                        <MudTh>이메일</MudTh>
                        <MudTh>표시명</MudTh>
                        <MudTh>역할</MudTh>
                        <MudTh>가입일</MudTh>
                        <MudTh>상태</MudTh>
                        <MudTh>작업</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="ID">@context.Id</MudTd>
                        <MudTd DataLabel="사용자명">@context.Username</MudTd>
                        <MudTd DataLabel="이메일">@context.Email</MudTd>
                        <MudTd DataLabel="표시명">@context.DisplayName</MudTd>
                        <MudTd DataLabel="역할">
                            @if (context.UserRoles.Any())
                            {
                                @foreach (var userRole in context.UserRoles)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="mr-1">
                                        @userRole.Role.DisplayName
                                    </MudChip>
                                }
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">역할 없음</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="가입일">@context.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</MudTd>
                        <MudTd DataLabel="상태">
                            <MudChip T="string" Size="Size.Small" Color="@(context.IsActive ? Color.Success : Color.Default)">
                                @(context.IsActive ? "활성" : "비활성")
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="작업">
                            <MudStack Row="true" Spacing="1">
                                <MudTooltip Text="사용자 정보 수정">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                 Color="Color.Info"
                                                 Size="Size.Small"
                                                 OnClick="@(() => EditUserAsync(context))" />
                                </MudTooltip>
                                <MudTooltip Text="역할 관리">
                                    <MudIconButton Icon="@Icons.Material.Filled.Security"
                                                 Color="Color.Secondary"
                                                 Size="Size.Small"
                                                 OnClick="@(() => ManageRolesAsync(context))" />
                                </MudTooltip>
                                <MudTooltip Text="비밀번호 초기화">
                                    <MudIconButton Icon="@Icons.Material.Filled.LockReset"
                                                 Color="Color.Primary"
                                                 Size="Size.Small"
                                                 OnClick="@(() => ResetPasswordAsync(context))" />
                                </MudTooltip>
                                <MudTooltip Text="@(context.IsActive ? "비활성화" : "활성화")">
                                    <MudIconButton Icon="@(context.IsActive ? Icons.Material.Filled.Block : Icons.Material.Filled.CheckCircle)"
                                                 Color="@(context.IsActive ? Color.Warning : Color.Success)"
                                                 Size="Size.Small"
                                                 OnClick="@(() => ToggleUserStatusAsync(context))" />
                                </MudTooltip>
                            </MudStack>
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[] { 20, 50, 100 }" />
                    </PagerContent>
                </MudTable>

                <!-- Statistics -->
                <MudText Typo="Typo.caption" Class="mt-4" Color="Color.Secondary">
                    전체 사용자: @(_totalCount)명 | 현재 페이지: @(_users.Count)명
                </MudText>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    private bool _isLoading = true;
    private List<User> _users = new();
    private int _totalCount = 0;
    private string _searchQuery = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
        _isLoading = false;
    }

    private async Task LoadUsersAsync()
    {
        _isLoading = true;
        StateHasChanged();

        var (users, totalCount) = await UserService.GetUsersPagedAsync(1, 100);
        _users = users;
        _totalCount = totalCount;

        _isLoading = false;
        StateHasChanged();
    }

    private async Task SearchUsersAsync()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
        {
            await LoadUsersAsync();
            return;
        }

        _isLoading = true;
        StateHasChanged();

        _users = await UserService.SearchUsersAsync(_searchQuery);
        _totalCount = _users.Count;

        _isLoading = false;
        StateHasChanged();
    }

    private async Task EditUserAsync(User user)
    {
        var parameters = new DialogParameters<EditUserDialog>
        {
            { x => x.UserId, user.Id },
            { x => x.Email, user.Email },
            { x => x.DisplayName, user.DisplayName }
        };

        var dialog = await DialogService.ShowAsync<EditUserDialog>("사용자 정보 수정", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadUsersAsync();
            Snackbar.Add("사용자 정보가 수정되었습니다.", Severity.Success);
        }
    }

    private async Task ManageRolesAsync(User user)
    {
        var parameters = new DialogParameters<ManageRolesDialog>
        {
            { x => x.UserId, user.Id },
            { x => x.Username, user.Username }
        };

        var dialog = await DialogService.ShowAsync<ManageRolesDialog>("역할 관리", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadUsersAsync();
            Snackbar.Add("역할이 변경되었습니다.", Severity.Success);
        }
    }

    private async Task ResetPasswordAsync(User user)
    {
        var parameters = new DialogParameters<ResetPasswordDialog>
        {
            { x => x.UserId, user.Id },
            { x => x.Username, user.Username }
        };

        var dialog = await DialogService.ShowAsync<ResetPasswordDialog>("비밀번호 초기화", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Snackbar.Add($"{user.Username}의 비밀번호가 초기화되었습니다.", Severity.Success);
        }
    }

    private async Task ToggleUserStatusAsync(User user)
    {
        var action = user.IsActive ? "비활성화" : "활성화";
        var confirmed = await DialogService.ShowMessageBox(
            "확인",
            $"{user.Username} 사용자를 {action}하시겠습니까?",
            yesText: "확인",
            cancelText: "취소"
        );

        if (confirmed == true)
        {
            var success = await UserService.SetUserActiveStatusAsync(user.Id, !user.IsActive);
            if (success)
            {
                await LoadUsersAsync();
                Snackbar.Add($"사용자가 {action}되었습니다.", Severity.Success);
            }
            else
            {
                Snackbar.Add("작업 실패", Severity.Error);
            }
        }
    }
}
