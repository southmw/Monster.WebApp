@using Monster.WebApp.Services.Auth
@using MudBlazor
@inject UserService UserService
@inject ISnackbar Snackbar
@rendermode InteractiveAuto

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.body1" Class="mb-4">
            <strong>@Username</strong> 사용자의 비밀번호를 재설정합니다.
        </MudText>

        <MudForm @ref="_form" @bind-IsValid="@_isValid">
            <MudTextField @bind-Value="_newPassword"
                         Label="새 비밀번호"
                         Required="true"
                         RequiredError="비밀번호를 입력하세요"
                         InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                         Adornment="Adornment.End"
                         AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                         OnAdornmentClick="() => _showPassword = !_showPassword"
                         Variant="Variant.Outlined"
                         HelperText="최소 8자, 대문자/소문자/숫자/특수문자 포함"
                         Class="mb-3" />
            <MudTextField @bind-Value="_confirmPassword"
                         Label="비밀번호 확인"
                         Required="true"
                         RequiredError="비밀번호 확인을 입력하세요"
                         InputType="@(_showConfirmPassword ? InputType.Text : InputType.Password)"
                         Adornment="Adornment.End"
                         AdornmentIcon="@(_showConfirmPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                         OnAdornmentClick="() => _showConfirmPassword = !_showConfirmPassword"
                         Variant="Variant.Outlined"
                         Class="mb-3" />
        </MudForm>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-2">@_errorMessage</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">취소</MudButton>
        <MudButton Color="Color.Warning" Variant="Variant.Filled" OnClick="Submit" Disabled="@(!_isValid || _isSubmitting)">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            비밀번호 재설정
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private MudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public int UserId { get; set; }

    [Parameter]
    public string Username { get; set; } = string.Empty;

    private MudForm _form = null!;
    private bool _isValid = false;
    private bool _isSubmitting = false;
    private bool _showPassword = false;
    private bool _showConfirmPassword = false;

    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private string _errorMessage = string.Empty;

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private async Task Submit()
    {
        _errorMessage = string.Empty;
        await _form.Validate();

        if (!_isValid) return;

        // Validate password policy
        var validationResult = ValidatePassword(_newPassword);
        if (!validationResult.IsValid)
        {
            _errorMessage = validationResult.Message;
            return;
        }

        // Check password match
        if (_newPassword != _confirmPassword)
        {
            _errorMessage = "비밀번호가 일치하지 않습니다.";
            return;
        }

        _isSubmitting = true;

        try
        {
            var success = await UserService.ResetPasswordAsync(UserId, _newPassword);
            if (success)
            {
                MudDialog?.Close(DialogResult.Ok(true));
            }
            else
            {
                _errorMessage = "비밀번호 재설정에 실패했습니다.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"오류가 발생했습니다: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private (bool IsValid, string Message) ValidatePassword(string password)
    {
        if (string.IsNullOrEmpty(password))
            return (false, "비밀번호를 입력하세요.");

        if (password.Length < 8)
            return (false, "비밀번호는 최소 8자 이상이어야 합니다.");

        if (!password.Any(char.IsUpper))
            return (false, "대문자가 1개 이상 포함되어야 합니다.");

        if (!password.Any(char.IsLower))
            return (false, "소문자가 1개 이상 포함되어야 합니다.");

        if (!password.Any(char.IsDigit))
            return (false, "숫자가 1개 이상 포함되어야 합니다.");

        if (!password.Any(c => "!@#$%^&*()_+-=[]{}|;':\",./<>?".Contains(c)))
            return (false, "특수문자가 1개 이상 포함되어야 합니다.");

        return (true, string.Empty);
    }
}
